Parent:     580fc133 (Doc/QButtonGroup: Do not mention deprecated/removed signal)
Author:     Ilya Fedin <fedin-ilja2010@ya.ru>
AuthorDate: 2023-03-22 23:47:00 +0400
Commit:     Ilya Fedin <fedin-ilja2010@ya.ru>
CommitDate: 2023-03-23 02:01:54 +0400

Fix build without egl_x11

Amends 49d29440457a89bb0438ed882eb47f4f28fd328a

Pick-to: 6.5 6.5.0
Change-Id: I5ff94135245cdb617aa5eea5a0e2782f810b36dc
Upstream-Status: Submitted [https://codereview.qt-project.org/c/qt/qtbase/+/468419]
Signed-off-by: Tom Hochstein <tom.hochstein@nxp.com>
Index: git/src/gui/opengl/platform/egl/qeglstreamconvenience.cpp
===================================================================
--- git.orig/src/gui/opengl/platform/egl/qeglstreamconvenience.cpp
+++ git/src/gui/opengl/platform/egl/qeglstreamconvenience.cpp
@@ -27,6 +27,7 @@ QEGLStreamConvenience::QEGLStreamConveni
     query_devices = reinterpret_cast<PFNEGLQUERYDEVICESEXTPROC>(eglGetProcAddress("eglQueryDevicesEXT"));
     query_device_string = reinterpret_cast<PFNEGLQUERYDEVICESTRINGEXTPROC>(eglGetProcAddress("eglQueryDeviceStringEXT"));
     get_platform_display = reinterpret_cast<PFNEGLGETPLATFORMDISPLAYEXTPROC>(eglGetProcAddress("eglGetPlatformDisplayEXT"));
+    create_platform_window_surface = reinterpret_cast<PFNEGLCREATEPLATFORMWINDOWSURFACEEXTPROC>(eglGetProcAddress("eglCreatePlatformWindowSurfaceEXT"));
 
     has_egl_device_base = strstr(extensions, "EGL_EXT_device_base");
     has_egl_platform_device = strstr(extensions, "EGL_EXT_platform_device");
Index: git/src/gui/opengl/platform/egl/qeglstreamconvenience_p.h
===================================================================
--- git.orig/src/gui/opengl/platform/egl/qeglstreamconvenience_p.h
+++ git/src/gui/opengl/platform/egl/qeglstreamconvenience_p.h
@@ -28,6 +28,7 @@ typedef intptr_t EGLAttrib;
 
 #ifndef EGL_EXT_platform_base
 typedef EGLDisplay (EGLAPIENTRYP PFNEGLGETPLATFORMDISPLAYEXTPROC) (EGLenum platform, void *native_display, const EGLint *attrib_list);
+typedef EGLSurface (EGLAPIENTRYP PFNEGLCREATEPLATFORMWINDOWSURFACEEXTPROC) (EGLDisplay dpy, EGLConfig config, void *native_window, const EGLint *attrib_list);
 #endif
 
 #ifndef EGL_EXT_device_base
@@ -134,6 +135,7 @@ public:
     void initialize(EGLDisplay dpy);
 
     PFNEGLGETPLATFORMDISPLAYEXTPROC get_platform_display;
+    PFNEGLCREATEPLATFORMWINDOWSURFACEEXTPROC create_platform_window_surface;
     PFNEGLQUERYDEVICESEXTPROC query_devices;
     PFNEGLQUERYDEVICESTRINGEXTPROC query_device_string;
     PFNEGLCREATESTREAMKHRPROC create_stream;
Index: git/src/plugins/platforms/xcb/gl_integrations/xcb_egl/qxcbeglintegration.cpp
===================================================================
--- git.orig/src/plugins/platforms/xcb/gl_integrations/xcb_egl/qxcbeglintegration.cpp
+++ git/src/plugins/platforms/xcb/gl_integrations/xcb_egl/qxcbeglintegration.cpp
@@ -103,6 +103,9 @@ bool QXcbEglIntegration::initialize(QXcb
         qCDebug(lcQpaGl) << "Xcb EGL gl-integration retrying with display" << m_egl_display;
         success = eglInitialize(m_egl_display, &major, &minor);
     }
+#else
+    if (success)
+        success = QEGLStreamConvenience().create_platform_window_surface;
 #endif
 
     m_native_interface_handler.reset(new QXcbEglNativeInterfaceHandler(connection->nativeInterface()));
